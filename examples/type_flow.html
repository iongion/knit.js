
<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width">
    <title>Woven Silk</title>
<!--    <link rel="stylesheet" href="/css/normalize.min.css">-->
    <script src="js/vendor/jquery-1.10.1.min.js" type="text/javascript"></script>
       
    <script src="js/vendor/poly2tri.js"></script>
    <script src="js/vendor/typeface-0.15.js"></script>
    <script src="js/vendor/helvetiker_regular.typeface.js"></script>
    <script src="js/vendor/helvetiker_bold.typeface.js"></script>
    <script src="js/vendor/helvetiker_bold_italic.typeface.js"></script>
    <script src="js/vendor/montserrat_regular.typeface.js"></script>
    <script src="js/vendor/stalemate_regular.typeface.js"></script>
      
      <script src="js/knit.js"></script>
      <style>
        body { 
            color: black;
            background: #aaaaaa; 
        }
      
        div.info {
            position: absolute;
            top: 0;
            left: 0;
            padding: 10px;
            z-index: 10;
        }
        canvas { 
            background-color: white; 
        }</style>
  </head>
    
  <body> 
      <div class="info">
          <p>Move the mouse to push, click and drag to tear
          </p>
          <p>Type a key to see the letter, or press SPACE to reset</p>
      </div>
      <div id="canvas-container">
          
      </div>  
<script>
    var width = window.innerWidth;
    var height = 500;
    $("<canvas/>", {
        id: "canvas",
    }).css({
        "position": "absolute",
        "top": 0,
        "left": 0,
    }).appendTo($("#canvas-container"));
    var canvas = $("#canvas");
    canvas[0].width = width;
    canvas[0].height = height;
    
    var context = canvas[0].getContext("2d");
    
    setInterval(update, 1000/60);
    
    var clothWidth = 30;
    var clothHeight = 25;
    var start_x = 50;
    var start_y = 100;
    var spacing = 10;
    var stiff = 0.52;
    var tear = null;
    
    var mouseInfluence = 5;
    var mouseScale = 0.5;
    var mouseMaxDist = 15;
    var steps = 6;
    
    var mouseTearInfluence = 4;
    var gravity = 10;
    var mass = 0.1;
    var useFloor = true;
    
    var fontSize = 250; 
//    var face = TypeUtil.getFace("helvetiker");
    var face = TypeUtil.getFace("stalemate");
    var text = "string";
    
    var world = new Knit.World(new Knit.Vec2(0, gravity));
    world.removablePins = true;
    world.setPinRemoveInfluence(15);
    
    if (useFloor) {
        world.bounds = new Knit.Rect(0, 0, width, height);
        world.floor = height-5;
    }
    
    function showText(str) {
        var xPos = start_x;
        var yPos = start_y;
        
        for (var i=0; i<str.length; i++) {
            var xOff = createTextFabric(face, xPos, yPos, str.charAt(i), steps, mass);
            xPos += xOff;
        }
    }
    
    $(document).keypress(function(e) {
        world.points = [];
        if (e.which==32)
            showText(text);
        else
            createTextFabric(face, start_x, start_y, String.fromCharCode(e.which), steps, mass);
        
    }); 
    $(function() {
        showText(text); 
    });
    
    var mouseDown = false;
    canvas.mousedown(function(ev) {
        if (ev.which == 1)
            mouseDown = true;
    });
    canvas.mouseup(function(ev) {
        if (ev.which == 1)
            mouseDown = false;
    });
     
    
    canvas.mousemove(function(ev) {
        if (mouseDown) {
            world.applyTear(ev.clientX, ev.clientY, mouseTearInfluence);
            world.applyMotion(ev.clientX, ev.clientY, mouseInfluence, mouseScale, mouseMaxDist);
        } else
            world.applyMotion(ev.clientX, ev.clientY, mouseInfluence, mouseScale, mouseMaxDist);
    });
    
    function createCloth() {
        for (var y=0; y<=clothHeight; y++) {
            for (var x=0; x<=clothWidth; x++) {
                var p = new Knit.PointMass(start_x + x * spacing, start_y + y * spacing, 2);
                
                (x!==0) && p.attach( world.points[world.points.length-1], spacing, stiff, tear );  
                (y===0) && p.pin( p.position.x, p.position.y );
                (y!==0) && p.attach( world.points[ x + (y - 1) * (clothWidth + 1)], spacing, stiff, tear );            
                
                world.points.push(p);
            }
        }
    }
    
    function createTextFabric(face, x, y, char, steps, mass) {
        var shapes = TypeUtil.getPointLists(face, fontSize, char, steps);
        
        if (shapes==null)
            return;
        
        
        var glyph = face.glyphs[char];
        
        for (var j=0; j<shapes.length; j++) {
            var points = shapes[j];
            var pointMasses = [];
            
            for (var i=0; i<points.length; i++) {
                var p = new Knit.PointMass(x + points[i].x, y + points[i].y, mass);
                pointMasses.push(p);
                
                
                
                if (i>0) {
                    var pOther = pointMasses[i-1];
                    
                    var len = p.position.distance(pOther.position);
                    p.attach(pOther, len, stiff, tear);  
                }
                
//                if (i == 0 ) {
                    p.pin(p.position.x, p.position.y, true /* weak pin */); 
//                }

                world.points.push(p);
            }
        } 
        
        var pointScale = TypeUtil.getPointScale(face, fontSize);
        return (glyph && glyph.ha) ? glyph.ha * pointScale : 0;
    }
    
    var stepper = 100;
    
    function update() { 
        context.clearRect(0, 0, width, height);
        
        world.step(.016);
        
        context.fillStyle = "black";
        stepper++;
        if (stepper>1000)
            stepper = 100;
        var windX = width/4 + Math.sin(stepper*0.0035 * Math.cos(stepper*0.01)) * width/4;
        var windY = height/2 + Math.sin(stepper*0.05) * height/2;
        context.fillRect(windX, windY, 10, 10);
        world.applyTear(windX, windY, mouseInfluence);
        world.applyMotion(windX, windY, mouseInfluence, mouseScale, mouseMaxDist);
        
        context.fillStyle = "blue";
        context.strokeStyle= "red";
//        pointsAlongLine(50, 50, 150, 150);
        
        
        context.save();
        context.translate(5, 5);
         
//        context.beginPath();
//        for (var i=0; i<triangles.length; i++) {
//            var tri = triangles[i];
//            var pointMasses = [];
//            
//            
//            for (var k=0; k<3; k++) {
//                var tpoint = tri.getPoint(k);
//                
//                if (k==0) {
//                    context.moveTo(tpoint.x, tpoint.y);   
//                } else {
//                    context.lineTo(tpoint.x, tpoint.y);   
//                }
////                context.fillRect(tpoint.x-0.5, tpoint.y-0.5, 1, 1);
//            }
//        }
//        context.closePath();
//        context.stroke();
//        
//        var sz = 2;
//        for (var i=0; i<contour.length; i++) {
//            var c = contour[i];   
//            context.fillRect(c.x-sz/2, c.y-sz/2, sz, sz);
//        }
        
//        moveTo(50, 150);
//        cubicCurve(5, 85, 25, 25, 100, 100);
//        context.beginPath();
//        context.moveTo(50, 150);        
//        context.bezierCurveTo(5, 85, 25, 25, 100, 100);
//        context.closePath();
//        context.stroke();
        
//        var shapes = pointsFromGlyph(face, style, 'p', 20);
//        for (var u=0; u<shapes.length; u++) {
//            var points = shapes[u];
//            for (var k=0; k<points.length; k++) {
//                var pt = points[k]; 
//                context.fillRect(pt.x, pt.y, 1, 1); 
//            }
//        }
            
        
        
//        context.beginPath();
//        _renderGlyph(context, face, 'o', style);
//        context.closePath();
//        context.fill();
        
        context.restore();
        
        var i = world.points.length;
        context.beginPath();
        while (i-- > 1) {
            var p = world.points[i];    
            context.fillStyle = "red";
            context.strokeStyle = "rgba(25,25,25,0.95)";
            context.lineWidth = 0.5;
            
            for (var j=0; j<p.constraints.length; j++) {
                var c = p.constraints[j];
                context.moveTo(c.p1.position.x, c.p1.position.y);
                context.lineTo(c.p2.position.x, c.p2.position.y);
            }
            
//                context.fillRect(c.p1.position.x, c.p1.position.y, 2, 2);
            
//            context.moveTo(p.position.x, p.position.y);
//            conte
//            context.fillRect(p.position.x, p.position.y, 5, 5);
        }
        context.closePath();
        context.stroke();
        
//        context.fontStyle = "arial";
//        context.fillStyle = "black"; 
//        context.fillText(world.points.length, 50, 50);
    }
</script>
       
  </body>
</html>